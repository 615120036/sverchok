language: bash
sudo: enabled

branches:
  only:
    master

install:
  - |
    if [ ! -f installation/blender/blender ]
    then 
        mkdir -p installation
        cd installation
        wget https://ftp.nluug.nl/pub/graphics/blender/release/Blender2.79/blender-2.79b-linux-glibc219-x86_64.tar.bz2
        tar xf blender-2.79b-linux-glibc219-x86_64.tar.bz2
        if [ -d blender ]
        then rm -rf blender
        fi
        mv blender-2.79b-linux-glibc219-x86_64 blender
        rm blender-2.79b-linux-glibc219-x86_64.tar.bz2
        echo "Current directory after downloading blender: $(pwd)"
        cd ..
    fi
    ln -s ${PWD} ${PWD}/installation/blender/2.79/scripts/addons/sverchok
    mkdir -p ~/.config/blender/2.79/config/
    ln -s ${PWD}/tests/references/userpref.blend ~/.config/blender/2.79/config/

env:
  - BLENDER=${PWD}/installation/blender/blender-softwaregl

# Actually run all tests.
script:
  - bash ./run_tests.sh
  - bash ./build_docs.sh

deploy:
  provider: pages
  skip_cleanup: true
  api_key: $GITHUB_TOKEN
  keep_history: true
  file: docs/_build/html.tar.bz2
  draft: true
  on:
    tags: true
    branch: b28_prelease_master

cache:
  directories:
    - ${PWD}/installation

